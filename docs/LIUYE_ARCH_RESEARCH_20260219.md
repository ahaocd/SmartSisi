# 柳叶-公会前链路研究记录（2026-02-20）

## 1. 用户目标（复述）
- 你和柳叶的聊天要独立、实时，不被公会执行链路拖慢。
- 柳叶可以在任何时刻给公会下任务，但不能“口头承诺已提交”而实际没提交。
- 柳叶在交互过程中要能接收公会事件，并决定是否立即播报给你。
- 你要的是系统化测试和可验证证据，不要硬编码兜底话术。

## 2. 本机实测（2026-02-20）

### 2.1 运行探针结果
- 文件：`runtime/liuye_probe_skip_turn_now.json`
  - 结果：6/6 通过
  - 平均延迟：85ms
  - SSE 首包：16ms
- 文件：`runtime/liuye_probe_full_now.json`
  - 结果：7/8 通过
  - 失败点：`POST /api/v1/liuye/session/<id>/turn` 在 12004ms 超时
  - 同批次：`POST /api/v1/liuye/session` 用时约 5003ms

### 2.2 关键日志与审计
- `logs/log-20260219154847.log` 持续出现：
  - `WebSocket连接失败 ... ('127.0.0.1', 18789)`
- `evoliu/guild_data/audit/audit-20260219.jsonl` 统计：
  - `listener_start=15`
  - `listener_error=14`
  - `listener_stopped=14`
  - `submit_task=1`
  - `dissolve_guild=1`
- 本机端口检查：18789 当前没有监听进程。

### 2.3 代码路径确认
- `gui/flask_server.py` 当前 `/turn` 仍是同步阻塞：
  - 先执行 `reply = liuye.process_user_input(...)`
  - 后进入 `if data.get("stream")` 分支
- 这意味着当前 `stream=true` 不是“边生成边推流”，而是“计算结束后再输出”。

## 3. 架构判定（针对你的三方关系）

### 3.1 双通道是对的，但要解耦
- 会话通道（User <-> 柳叶）：低延迟、可打断、不可被长任务阻塞。
- 任务通道（柳叶 <-> 公会）：异步、可排队、可取消、可重试。

### 3.2 你当前的主要问题不是“没配模型”
- 你的模型网关链路可达（8001 可响应）。
- 当前第一瓶颈是公会执行传输链路离线（18789 无监听）。
- 当前第二瓶颈是 `/turn` 阻塞实现导致交互体感“卡住”。

## 4. 2026 协议核验（用于前链路改造）

### 4.1 MCP（当前版本）
- 版本页显示当前协议版本：`2025-11-25`。
- `2025-11-25` 关键新增：
  - experimental `tasks`（耐久任务、轮询、延迟取结果）
  - 允许 SSE 流断开后轮询/恢复
  - 采样支持 `tools`/`toolChoice`
- 对应你的系统价值：可直接映射“柳叶先回你 + 公会后台跑 + 前端持续看状态”。

### 4.2 HTTP 异步语义
- RFC 9110 `202 Accepted`：语义是“已接收处理请求，但未完成”，且是非承诺性状态。
- RFC 7240 `Prefer: respond-async`：客户端可明确表达异步响应偏好。

### 4.3 OpenAI 平台接口趋势（2026）
- Deprecations 页显示：Realtime Beta（`OpenAI-Beta: realtime=v1`）计划下线日期为 `2026-02-27`。
- Background mode 指南：支持 `queued/in_progress` 状态轮询、取消、以及 background+stream。
- Webhooks 指南：按 Standard Webhooks 规范投递，支持签名验签。

### 4.4 传输层现实约束
- MDN SSE 指南明确：SSE 是单向（服务端 -> 客户端）。
- MDN 警告：HTTP/1.1 下每域名连接数上限低（常见 6）；HTTP/2 可提高并发流上限。

## 5. 主线改造计划（不含备用分支）

### P0（先修可用性，今天）
- 目标：先恢复公会执行链路可达。
- 动作：
  - 启动/修复 18789 监听服务。
  - 增加启动自检：`openclaw_ws_url` 连接失败时前端红灯提示。
- 验收：
  - 连续 10 分钟无 `listener_error`。
  - `submit_task` 后 2s 内出现 `running` 事件。

### P1（交互解阻塞，第一优先）
- 目标：实现“先回复你，再执行任务”。
- 动作：
  - 重构 `/api/v1/liuye/session/<id>/turn` 为 ACK-first：
    - 先返回 ACK（<=500ms），含 `turn_id/trace_id`。
    - 实际推理与工具调用放后台执行。
  - 新增 `turn status` 查询接口 + 事件流回推。
- 验收：
  - P95 ACK < 500ms。
  - `turn_timeout_rate` < 1%。

### P2（事件契约统一，解决“真假提交”）
- 目标：所有“已提交/执行中/完成/失败”都可追踪。
- 动作：
  - 建立统一事件模型：`ack -> tool_call_started -> tool_call_result -> guild_state_changed -> final`。
  - 每个事件强制携带 `trace_id + correlation_id + task_id(optional)`。
  - 前端只显示有证据链的状态，不展示口头承诺型文案。
- 验收：
  - `false_commit_rate = 0`（出现“已提交”时必须存在审计 `submit_task` 记录）。

### P3（可打断与控制面，保障实时感）
- 目标：任何时刻可中断、停止、解散。
- 动作：
  - 新增 `turn cancel`、`task abort`、`guild dissolve` 的统一控制接口。
  - 打断时同步截断未播报文本，避免上下文污染。
- 验收：
  - `interrupt_to_stop_ms` P95 < 300ms。
  - 取消后不再出现旧任务尾流回包。

### P4（系统化测试与回归门禁）
- 目标：把你的关注点变成自动化门禁。
- 动作：
  - 合同测试：状态机、字段完整性、trace 贯通。
  - 时序测试：ACK、首包、完成、取消。
  - 在线探针：每小时跑一轮并写 JSON 报告。
- 验收：
  - CI 必须通过：合同 + 时序 + 探针。
  - 线上周报包含 SLA 曲线和异常样本。

## 6. “先回复你”的标准解释（避免歧义）
- 正确含义：先回 ACK（确认收到并开始处理）。
- 不可做法：在工具结果未返回前，说“我已经提交成功/已经查完”。
- 建议文案模板：
  - ACK：`收到，我马上处理。任务已进入执行流程，我会持续同步进度。`
  - 未触发公会：`这轮没有调用公会，我先直接回答你。`
  - 已入队待执行：`公会离线，任务已入队，恢复连接后自动执行。`

## 7. 风险清单（当前最可能出问题的位置）
- `/turn` 同步阻塞导致超时和“假流式”体验。
- 18789 离线导致任务长期 pending/running 但无推进。
- 多事件源（柳叶文本流、公会事件流）没有统一时序基准时，前端显示会错乱。

## 8. 下一步执行顺序（建议）
1. 先做 P0：恢复 18789 + 健康检查门禁。
2. 立即并行推进 P1：把 `/turn` 改成 ACK-first。
3. 完成 P2：trace 贯通和前端状态证据化显示。
4. 最后收口 P3/P4：打断控制与自动化回归。
